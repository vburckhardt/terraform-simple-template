# terraform-lab-devfile.yaml
schemaVersion: 2.2.0
metadata:
  name: terraform
  displayName: Terraform Environment

components:
  - name: dev-tools
    container:
      image: quay.io/devfile/base-developer-image:ubi9-latest
      memoryLimit: 4Gi
      cpuLimit: 2000m
      memoryRequest: 1Gi
      cpuRequest: 500m
      mountSources: true

commands:
  - id: install-tools-exec
    exec:
      component: dev-tools
      commandLine: |
        # Install Terraform via tfswitch
        curl -L https://raw.githubusercontent.com/warrensbox/terraform-switcher/master/install.sh | bash
        tfswitch        
        
        # Install IBM Cloud CLI
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
        ibmcloud plugin install -a
        
        # Verify install
        terraform version
        ibmcloud version
      workingDir: /workspaces/terraform-simple-template

  - id: install-vscode-extensions-exec
    exec:
      component: dev-tools
      commandLine: |
        code-server --install-extension HashiCorp.terraform
        # code-server --install-extension redhat.vscode-yaml
        # code-server --install-extension ms-vscode.json
        # code-server --install-extension GitLab.gitlab-workflow
      workingDir: /workspaces/terraform-simple-template

  - id: install-tools
    composite:
      commands:
        - "install-tools-exec"
      group:
        kind: apply
        isDefault: true

  - id: install-vscode-extensions
    composite:
      commands:
        - "install-vscode-extensions-exec"
      group:
        kind: apply

  - id: startup
    composite:
      commands: 
        - "install-tools"
        - "install-vscode-extensions"
      group:
        kind: apply
        isDefault: true

events:
  preStart:
    - startup
